# ctrld configuration file
# Generated by Control D Device Configuration Generator
# Resolver ID: 1o6nbq1u58h
# Generated: 2025-08-13 11:47:10
#
# This configuration implements device-specific DNS routing using:
# - Control D upstream with custom resolver ID
# - Network policies for IP/MAC-based device grouping
# - LAN client discovery for device identification
# - Multiple upstream profiles for different device types

[service]
    log_level = "info"
    log_path = "/var/log/ctrld.log"

    # Caching configuration
    cache_enable = true
    cache_size = 8192
    cache_ttl_override = 300
    cache_serve_stale = true

    # LAN client discovery settings (from ctrld docs)
    # These enable device identification for policy routing
    discover_mdns = true        # mDNS discovery on port 5353
    discover_arp = true         # ARP table scanning
    discover_dhcp = true        # DHCP lease file parsing
    discover_ptr = true         # PTR query discovery
    discover_hosts = true       # Hosts file parsing
    discover_refresh_interval = 120  # Refresh every 2 minutes

    # Client identification preference
    client_id_preference = "mac"  # Prefer MAC for device ID

    # Metrics and monitoring
    metrics_listener = "127.0.0.1:9090"
    metrics_query_stats = true

[network.0]
    name = "Admin Devices"
    cidrs = ["192.168.1.10/32", "192.168.1.11/32"]

[network.1]
    name = "Family Devices"
    cidrs = ["192.168.1.20/32", "192.168.1.21/32", "192.168.1.22/32"]

[network.2]
    name = "Guest Devices"
    cidrs = ["192.168.1.50/32"]

[network.3]
    name = "IoT Devices"
    cidrs = ["192.168.1.100/32", "192.168.1.101/32", "192.168.1.102/32"]

[network.4]
    name = "Default Network"
    cidrs = ["0.0.0.0/0"]

[upstream.0]
    name = "Control D - Device Resolver 1o6nbq1u58h"
    endpoint = "https://dns.controld.com/1o6nbq1u58h"
    type = "doh"
    timeout = 5000
    bootstrap_ip = "76.76.2.11"
    ip_stack = "split"

[upstream.1]
    name = "Control D - Fallback"
    endpoint = "https://freedns.controld.com/p2"
    type = "doh"
    timeout = 5000
    bootstrap_ip = "76.76.2.22"
    ip_stack = "both"

[upstream.2]
    name = "Cloudflare - Secure"
    endpoint = "https://security.cloudflare-dns.com/dns-query"
    type = "doh"
    timeout = 5000
    bootstrap_ip = "1.1.1.2"
    ip_stack = "both"

[upstream.3]
    name = "Local DNS Fallback"
    endpoint = "8.8.8.8"
    type = "legacy"
    timeout = 3000

[listener.0]
    ip = "0.0.0.0"
    port = 53
    restricted = false  # Allow queries from all networks

[listener.0.policy]
    name = "Control D Device Routing Policy"

    networks = [
        {"network.0" = ["upstream.0"]},
        {"network.1" = ["upstream.0", "upstream.1"]},
        {"network.2" = ["upstream.2"]},
        {"network.3" = ["upstream.0", "upstream.3"]},
    ]

    macs = [
        {"aa:bb:cc:dd:ee:01" = ["upstream.0"]},
        {"aa:bb:cc:dd:ee:02" = ["upstream.0"]},
        {"11:22:33:44:55:01" = ["upstream.0", "upstream.1"]},
        {"11:22:33:44:55:02" = ["upstream.0", "upstream.1"]},
        {"11:22:33:44:55:03" = ["upstream.0", "upstream.1"]},
        {"66:77:88:99:aa:01" = ["upstream.2"]},
        {"99:88:77:66:55:01" = ["upstream.0", "upstream.3"]},
        {"99:88:77:66:55:02" = ["upstream.0", "upstream.3"]},
        {"99:88:77:66:55:03" = ["upstream.0", "upstream.3"]},
    ]

    rules = [
        {"*.local" = []},
        {"*.lan" = []},
        {"*.home" = []},
    ]
