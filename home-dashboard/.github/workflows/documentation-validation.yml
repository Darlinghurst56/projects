name: Documentation Quality Validation

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  documentation-validation:
    name: "ğŸ“š Documentation Quality Check"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ğŸ“‹ Check Required Documentation Files
        run: |
          echo "ğŸ” Checking for required documentation files..."
          
          # Check for essential files
          files_to_check=(
            "README.md"
            "CONTRIBUTING.md" 
            ".env.example"
            "package.json"
          )
          
          missing_files=()
          for file in "${files_to_check[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "âŒ Missing required documentation files:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          else
            echo "âœ… All required documentation files present"
          fi
      
      - name: ğŸ¯ Validate JSDoc Documentation
        run: |
          echo "ğŸ” Checking JSDoc documentation coverage..."
          
          # Check for functions without JSDoc
          undocumented_functions=$(grep -r "function\|const.*=.*=>" src/ server/ --include="*.js" --include="*.jsx" | \
            grep -v "/\*\*" | \
            grep -v "// TODO" | \
            wc -l)
          
          if [ "$undocumented_functions" -gt 0 ]; then
            echo "âš ï¸ Found $undocumented_functions potentially undocumented functions"
            echo "Please ensure all functions have proper JSDoc documentation"
          else
            echo "âœ… JSDoc documentation check passed"
          fi
      
      - name: ğŸ“ Check API Documentation
        run: |
          echo "ğŸ” Checking API endpoint documentation..."
          
          # Look for API routes and check if they're documented
          api_routes=$(find server/routes -name "*.js" 2>/dev/null | wc -l)
          
          if [ "$api_routes" -gt 0 ]; then
            echo "Found $api_routes API route files"
            
            # Check for basic API documentation patterns
            documented_routes=0
            for route_file in server/routes/*.js; do
              if [ -f "$route_file" ]; then
                if grep -q "@api\|@apiName\|@apiDescription" "$route_file"; then
                  documented_routes=$((documented_routes + 1))
                fi
              fi
            done
            
            echo "ğŸ“Š $documented_routes out of $api_routes route files have API documentation"
            
            if [ "$documented_routes" -lt "$api_routes" ]; then
              echo "âš ï¸ Some API routes may lack proper documentation"
              echo "Please ensure all API endpoints follow the documentation standards in CONTRIBUTING.md"
            fi
          fi
      
      - name: ğŸ”§ Check Environment Configuration
        run: |
          echo "ğŸ” Validating environment configuration documentation..."
          
          if [ -f ".env.example" ]; then
            # Check if .env.example has proper comments
            comment_lines=$(grep -c "^#" .env.example || true)
            total_lines=$(wc -l < .env.example)
            
            if [ "$total_lines" -gt 0 ]; then
              comment_ratio=$((comment_lines * 100 / total_lines))
              echo "ğŸ“Š Environment file has $comment_ratio% documentation coverage"
              
              if [ "$comment_ratio" -lt 30 ]; then
                echo "âš ï¸ .env.example needs more documentation comments"
                echo "Please add comments explaining each environment variable"
              else
                echo "âœ… Environment configuration is well documented"
              fi
            fi
          fi
      
      - name: ğŸ“– Validate README Content
        run: |
          echo "ğŸ” Checking README.md content quality..."
          
          if [ -f "README.md" ]; then
            # Check for essential README sections
            required_sections=(
              "# "
              "## Installation"
              "## Usage"
              "## Configuration"
            )
            
            missing_sections=()
            for section in "${required_sections[@]}"; do
              if ! grep -q "$section" README.md; then
                missing_sections+=("$section")
              fi
            done
            
            if [ ${#missing_sections[@]} -gt 0 ]; then
              echo "âš ï¸ README.md missing recommended sections:"
              printf '%s\n' "${missing_sections[@]}"
              echo "Consider adding these sections for better documentation"
            else
              echo "âœ… README.md has all essential sections"
            fi
            
            # Check README length (should be substantial)
            readme_lines=$(wc -l < README.md)
            if [ "$readme_lines" -lt 20 ]; then
              echo "âš ï¸ README.md seems too short ($readme_lines lines)"
              echo "Consider adding more detailed documentation"
            fi
          fi
      
      - name: ğŸ§¹ Check Code Comment Quality
        run: |
          echo "ğŸ” Analyzing code comment quality..."
          
          # Find files with very few comments
          low_comment_files=()
          
          for file in $(find src server -name "*.js" -o -name "*.jsx" 2>/dev/null); do
            if [ -f "$file" ]; then
              total_lines=$(wc -l < "$file")
              comment_lines=$(grep -c "^\s*\(//\|\*\)" "$file" || true)
              
              if [ "$total_lines" -gt 50 ] && [ "$comment_lines" -lt 5 ]; then
                low_comment_files+=("$file")
              fi
            fi
          done
          
          if [ ${#low_comment_files[@]} -gt 0 ]; then
            echo "âš ï¸ Files with potentially insufficient comments:"
            printf '%s\n' "${low_comment_files[@]}"
            echo "Consider adding more explanatory comments for complex logic"
          else
            echo "âœ… Code comment coverage looks adequate"
          fi
      
      - name: ğŸ” Check Security Documentation
        run: |
          echo "ğŸ” Checking security documentation..."
          
          # Look for security-related files and documentation
          security_files=0
          
          if [ -f "SECURITY.md" ]; then
            security_files=$((security_files + 1))
          fi
          
          if grep -q -i "security\|authentication\|authorization" README.md CONTRIBUTING.md 2>/dev/null; then
            security_files=$((security_files + 1))
          fi
          
          if [ "$security_files" -eq 0 ]; then
            echo "âš ï¸ No security documentation found"
            echo "Consider adding security guidelines to CONTRIBUTING.md or creating SECURITY.md"
          else
            echo "âœ… Security documentation present"
          fi
      
      - name: ğŸ“Š Documentation Quality Summary
        run: |
          echo ""
          echo "ğŸ¯ =========================="
          echo "ğŸ¯ DOCUMENTATION QUALITY SUMMARY"
          echo "ğŸ¯ =========================="
          echo ""
          
          # Count different types of documentation
          js_files=$(find src server -name "*.js" -o -name "*.jsx" 2>/dev/null | wc -l)
          md_files=$(find . -maxdepth 2 -name "*.md" | wc -l)
          
          echo "ğŸ“ Project Overview:"
          echo "   â€¢ JavaScript/JSX files: $js_files"
          echo "   â€¢ Documentation files: $md_files"
          
          if [ -f "CONTRIBUTING.md" ]; then
            echo "   â€¢ Contributing guidelines: âœ… Present"
          else
            echo "   â€¢ Contributing guidelines: âŒ Missing"
          fi
          
          if [ -f ".env.example" ]; then
            echo "   â€¢ Environment template: âœ… Present"
          else
            echo "   â€¢ Environment template: âŒ Missing"
          fi
          
          echo ""
          echo "ğŸ“‹ Next Steps:"
          echo "   1. Review any warnings above"
          echo "   2. Follow CONTRIBUTING.md guidelines for documentation"
          echo "   3. Add JSDoc comments to undocumented functions"
          echo "   4. Update README.md if sections are missing"
          echo ""
          echo "ğŸ‰ Documentation validation complete!"

  lint-check:
    name: "ğŸ” Code Quality & Linting"
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ğŸ” Run ESLint
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            echo "ğŸ” Running ESLint code quality check..."
            npm run lint
          else
            echo "âš ï¸ No ESLint configuration found"
            echo "Consider adding ESLint for code quality enforcement"
          fi
        continue-on-error: true
      
      - name: ğŸ§ª Run Tests (if available)
        run: |
          if npm run test --dry-run 2>/dev/null; then
            echo "ğŸ§ª Running test suite..."
            npm run test
          else
            echo "â„¹ï¸ No test script found in package.json"
          fi
        continue-on-error: true

  dependency-check:
    name: "ğŸ”’ Security & Dependencies"
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
      
      - name: ğŸ›¡ï¸ Security Audit
        run: |
          echo "ğŸ›¡ï¸ Running npm security audit..."
          npm audit --audit-level=moderate || echo "âš ï¸ Security vulnerabilities found - please review"
        continue-on-error: true
      
      - name: ğŸ“Š Dependency Analysis
        run: |
          echo "ğŸ“Š Analyzing dependencies..."
          
          # Check for package.json
          if [ -f "package.json" ]; then
            deps=$(node -e "console.log(Object.keys(require('./package.json').dependencies || {}).length)")
            devDeps=$(node -e "console.log(Object.keys(require('./package.json').devDependencies || {}).length)")
            
            echo "Dependencies: $deps production, $devDeps development"
            
            # Check for common security packages
            if grep -q "helmet\|express-rate-limit\|cors" package.json; then
              echo "âœ… Security middleware packages detected"
            else
              echo "âš ï¸ Consider adding security middleware (helmet, express-rate-limit, cors)"
            fi
          fi